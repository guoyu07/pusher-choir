<!DOCTYPE html>
<head>
  <title>Pusher Choir</title>
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.6.3/fabric.min.js"></script>
  <script src="https://js.pusher.com/3.0/pusher.min.js"></script>
  <script src="https://cdn.rawgit.com/leggetter/pusher-js-client-auth/master/dist/pusher-js-client-auth.js"></script>
  <script>

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    var instruments = {
      "chime-musical-synth-stutter": {
        "audio": new Audio("chime-musical-synth-stutter_zkzHu_E_.mp3"),
        "img_file": "replay-multiplayer.jpg",
        "img_left": 100,
        "img_top": 10,
      },
      "horse-whinny": {
        "audio": new Audio("horse-whinny-3_zyzWTbEu.mp3"),
        "img_file": "replay-multiplayer.jpg",
        "img_left": 400,
        "img_top": 10,
      }
    }

    // Enable pusher logging - don't include this in production
    Pusher.logToConsole = true;

    var playerName = getParameterByName('name')

    // State
    var nameToInstrument = {}
    var instrumentToName = {}
    for (var i in instruments) {
      if (instruments.hasOwnProperty(i)) {
        instrumentToName[i] = null
      }
    }

    var pusher = new Pusher('<YOUR_APP_KEY>', {
        authTransport: 'client',
        clientAuth: {
          key: '<YOUR_APP_KEY>',
          secret: '<YOUR_APP_SECRET>',
          user_id: playerName,
          user_info: {}
        },
        cluster: 'eu'
    });

    var soundChannel = pusher.subscribe('presence-sound-channel');
    var instrumentChannel = pusher.subscribe('presence-instrument-channel');

    soundChannel.bind('client-p', function(inst) {
      instruments[inst].audio.play()
    });

    var backgroundMusic = new Audio('background.mp3');
    backgroundMusic.loop = true;
    backgroundMusic.play();

    $(window).keypress(function (e) {
      if (e.keyCode === 0 || e.keyCode === 32) {
        e.preventDefault()
        soundChannel.trigger('client-p', nameToInstrument[playerName]);
      }

      if (e.keyCode === 13) {
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
      }
    });
  </script>
</head>

<body bgcolor="#000000">
  <canvas id="myCanvas" width="1200" height="640"></canvas>
</body>

<script>
  var c = document.getElementById("myCanvas");
  c.style.backgroundColor = 'rgba(158, 167, 184, 0.2)';
  var canvas = new fabric.Canvas('myCanvas');

  // Name -> text object
  var instrumentTextObjects = {}

  // Update the state because someone has changed instrument
  instrumentChannel.bind('client-p', function(state) {
    console.log(state)
    for (var instrument in state) {
      if (state.hasOwnProperty(instrument)) {
        console.log(state[instrument])
        instrumentToName[instrument] = state[instrument]
        if (instrumentToName[instrument]) {
          instrumentTextObjects[instrument].setText(instrumentToName[instrument])
        } else {
          instrumentTextObjects[instrument].setText("")
        }
      }
    }
    canvas.renderAll();
  });

  for (var i in instruments) {
    if (instruments.hasOwnProperty(i)) {
      (function(iName, instrument) {
        fabric.Image.fromURL(instrument.img_file, function(oImg) {
          var text = new fabric.Text("", { left: instrument.img_left, top: instrument.img_top + 200 });
          text.hasControls = false;
          text.lockMovementX = true;
          text.lockMovementY = true;
          instrumentTextObjects[iName] = text
          canvas.add(text);

          oImg.left = instrument.img_left;
          oImg.top = instrument.img_top;
          oImg.selectable = false;
          oImg.hasControls = false;
          oImg.lockMovementX = true;
          oImg.lockMovementY = true;
          oImg.on('mousedown', function() {
            if (instrumentToName[iName] == playerName) { // we are using, remove
              text.setText("");
              nameToInstrument[playerName] = null
              instrumentToName[iName] = null
              instrumentChannel.trigger('client-p', instrumentToName);
            } else if (!instrumentToName[iName]) { // no player is using it, switch
              text.setText(playerName);
              if (nameToInstrument[playerName]) { // Remove from old instrument
                instrumentTextObjects[nameToInstrument[playerName]].setText("")
                instrumentToName[nameToInstrument[playerName]] = null
              }
              nameToInstrument[playerName] = iName
              instrumentToName[iName] = playerName
              instrumentChannel.trigger('client-p', instrumentToName);
            }
          });
          canvas.add(oImg);
        });
      })(i, instruments[i]);
    }
  }
</script>
